{% extends 'shop/basic.html' %}

{% block title %}Checkout{% endblock %}

{% block body %}
<div class="container my-5">
  <h2 class="mb-4">Checkout</h2>

  <!-- Cart Summary -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">ðŸ›’ Order Summary</h5>
      <div id="order-summary">
        <p>Your cart is empty.</p>
      </div>
      <div class="mt-3 text-end">
        <h5 id="order-total"></h5>
      </div>
    </div>
  </div>

  <!-- Checkout Form -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Your Details</h5>
      <form method="post" action="">
        {% csrf_token %}

        <!-- Hidden fields for cart JSON and total -->
        <input type="hidden" name="cartJson" id="cartJson">
        <input type="hidden" name="total_price" id="totalPrice">

        <div class="mb-3">
          <label for="name" class="form-label">Full Name</label>
          <input type="text" class="form-control" id="name" name="name" required>
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Email address</label>
          <input type="email" class="form-control" id="email" name="email" required>
        </div>

        <div class="mb-3">
          <label for="phone" class="form-label">Phone Number</label>
          <input type="tel" class="form-control" id="phone" name="phone" required>
        </div>

        <div class="mb-3">
          <label for="address" class="form-label">Delivery Address</label>
          <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
        </div>

        <button type="submit" class="btn btn-success w-100">Place Order</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const productsMap = JSON.parse("{{ products_map_json|escapejs }}");
  const cart = JSON.parse(localStorage.getItem('cart') || '{}');

  const orderSummaryEl = document.getElementById("order-summary");
  const orderTotalEl = document.getElementById("order-total");
  const hiddenCart = document.getElementById("cartJson");
  const totalPriceField = document.getElementById("totalPrice");

  if (!orderSummaryEl || !orderTotalEl || !hiddenCart || !totalPriceField) return;

  if (Object.keys(cart).length === 0) {
    orderSummaryEl.innerHTML = "<p>Your cart is empty.</p>";
    orderTotalEl.innerText = "";
    hiddenCart.value = JSON.stringify({ items: [], total_price: 0 });
    totalPriceField.value = 0;
    return;
  }

  let html = "<ul class='list-group list-group-flush'>";
  let total = 0;
  let i = 1;

  // Build cart data for backend
  let cartForBackend = [];

  for (let key in cart) {
    const qty = cart[key];
    const info = productsMap[key] || { name: `Product (${key})`, price: "0" };
    const name = info.name;
    const price = parseFloat(info.price) || 0;
    const subtotal = price * qty;
    total += subtotal;

    // Build cart item for backend
    cartForBackend.push({
      name: name,
      qty: qty,
      price: price,
      subtotal: subtotal
    });

    // Build frontend summary
    html += `
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>${i}.</strong> ${name}<br>
          <small class="text-muted">Unit: â‚¹${price.toFixed(2)}</small>
        </div>
        <div class="text-end">
          <div>Qty: <span class="fw-bold">${qty}</span></div>
          <div>Subtotal: â‚¹${subtotal.toFixed(2)}</div>
        </div>
      </li>
    `;
    i++;
  }
  html += "</ul>";

  orderSummaryEl.innerHTML = html;
  orderTotalEl.innerHTML = `Total: â‚¹<span id="checkoutTotal">${total.toFixed(2)}</span>`;

  // Send clean cart JSON to backend
  hiddenCart.value = JSON.stringify({
    items: cartForBackend,
    total_price: total
  });

  totalPriceField.value = total.toFixed(2);
});
</script>

{% endblock %}
